{% extends 'base.html' %}

{% block title %}Quản lý Tính Lương Nhân sự{% endblock %}

{% block content %}
<div class="container-fluid">
    {% for message in messages %}
        <div class="alert alert-{% if message.level_tag == 'error' %}danger{% else %}{{ message.level_tag }}{% endif %}">
            {{ message }}
        </div>
    {% endfor %}

    <h1 class="mt-4">Chức năng Tính Lương</h1>
    <hr>

    <div class="card mb-4">
        <div class="card-header"><h2>1. Kích hoạt Tính Lương</h2></div>
        <div class="card-body">
            {% if period_form %}
                <form method="post" class="mb-4">
                    {% csrf_token %}
                    {{ period_form.as_p }}
                    <button type="submit" class="btn btn-primary"><i class="fas fa-calculator"></i> Thực hiện Tính Lương</button>
                </form>
            {% else %}
                <p class="text-danger">Không thể tải Form lựa chọn kỳ lương.</p>
            {% endif %}
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            {% if period %}<h2>2. Bảng Lương Đã Tính (Kỳ: {{ period.name }})</h2>{% else %}<h2>2. Bảng Lương Đã Tính</h2>{% endif %}
        </div>
        <div class="card-body">
            {% if payroll_entries %}
                <p>Danh sách <strong>{{ payroll_entries|length }}</strong> bảng lương đã được tính cho kỳ này:</p>
                <ul class="list-group">
                {% for entry in payroll_entries %}
                    <li class="list-group-item">
                        <div class="row">
                            <div class="col-md-8">
                                <div><strong>Nhân viên:</strong> {{ entry.employee.full_name|default:entry.employee.employee_id }}</div>
                                <div><strong>Ngày công:</strong> {{ entry.actual_worked_days }} / {{ entry.standard_worked_days }} ngày</div>
                                <div><strong>Lương cơ bản (Rate):</strong> {{ entry.basic_salary|floatformat:2 }} VND</div>
                                <div><strong>Tổng Phụ cấp:</strong> {{ entry.total_allowance|floatformat:2 }} VND</div>
                                <div><strong>Tổng Thưởng:</strong> {{ entry.total_reward|floatformat:2 }} VND</div>
                            </div>
                            <div class="col-md-4 text-right">
                                <div class="h6 text-danger">THỰC LĨNH</div>
                                <div class="h4"><strong>{{ entry.received|floatformat:2 }} VND</strong></div>
                                <a href="#" class="btn btn-sm btn-outline-info mt-2">Xem chi tiết</a>
                            </div>
                        </div>
                    </li>
                {% empty %}
                    <p class="text-secondary">Chưa có bảng lương nào được tính cho kỳ này.</p>
                {% endfor %}
                </ul>
            {% else %}
                <p>Không có dữ liệu bảng lương để hiển thị. Vui lòng chọn kỳ và thực hiện tính toán.</p>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
