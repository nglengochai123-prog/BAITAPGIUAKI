{% extends 'base.html' %}

{% block title %}Qu·∫£n l√Ω T√≠nh L∆∞∆°ng Nh√¢n s·ª±{% endblock %}

{% block content %}
<div class="container-fluid">
    {% for message in messages %}
        <div class="alert alert-{% if message.level_tag == 'error' %}danger{% else %}{{ message.level_tag }}{% endif %}">
            {{ message }}
        </div>
    {% endfor %}

    <h1 class="mt-4">Ch·ª©c nƒÉng T√≠nh L∆∞∆°ng</h1>
    <hr>

    <div class="card mb-4">
        <div class="card-header"><h2>1. K√≠ch ho·∫°t T√≠nh L∆∞∆°ng</h2></div>
        <div class="card-body">
            {% if period_form %}
                <form method="post" class="mb-4">
                    {% csrf_token %}
                    {{ period_form.as_p }}
                    <button type="submit" class="btn btn-primary"><i class="fas fa-calculator"></i> Th·ª±c hi·ªán T√≠nh L∆∞∆°ng</button>
                </form>
            {% else %}
                <p class="text-danger">Kh√¥ng th·ªÉ t·∫£i Form l·ª±a ch·ªçn k·ª≥ l∆∞∆°ng.</p>
            {% endif %}
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            {% if period %}<h2>2. B·∫£ng L∆∞∆°ng ƒê√£ T√≠nh (K·ª≥: {{ period.name }})</h2>{% else %}<h2>2. B·∫£ng L∆∞∆°ng ƒê√£ T√≠nh</h2>{% endif %}
        </div>

        <div class="card-body">
            {# ----- FILTER BAR: ch√®n ngay ph√≠a tr√™n danh s√°ch k·∫øt qu·∫£ ----- #}
            {% if period %}
            <form method="get" class="form-inline mb-3">
                {# gi·ªØ period ƒë·ªÉ kh√¥ng m·∫•t khi submit filter #}
                <input type="hidden" name="period" value="{{ period.id }}">

                <div class="form-group mr-2">
                    <input type="text" name="q" value="{{ request.GET.q|default_if_none:'' }}" class="form-control" placeholder="T√¨m t√™n ho·∫∑c M√£ NV">
                </div>

                <div class="form-group mr-2">
                    <select name="component" class="form-control">
                        <option value="">-- T·∫•t c·∫£ th√†nh ph·∫ßn l∆∞∆°ng --</option>
                        {% for c in salary_components %}
                            <option value="{{ c.id }}" {% if request.GET.component == c.id|stringformat:"s" %}selected{% endif %}>{{ c.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group mr-2">
                    <select name="department" class="form-control">
                        <option value="">-- T·∫•t c·∫£ ph√≤ng ban --</option>
                        {% for d in departments %}
                            <option value="{{ d.id }}" {% if request.GET.department == d.id|stringformat:"s" %}selected{% endif %}>{{ d.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <button type="submit" class="btn btn-outline-primary mr-2">L·ªçc</button>

{# N√∫t Xu·∫•t Excel: d√πng path param cho export v√† gi·ªØ c√°c query params kh√°c #}
<a class="btn btn-success"
   href="{% url 'export_payroll_excel' period.id %}{% if request.GET.q or request.GET.component or request.GET.department %}?{% if request.GET.q %}q={{ request.GET.q|urlencode }}&{% endif %}{% if request.GET.component %}component={{ request.GET.component }}&{% endif %}{% if request.GET.department %}department={{ request.GET.department }}{% endif %}{% endif %}">
    üì§ Xu·∫•t Excel (theo filter)
</a>

            </form>
            {% endif %}
            {# ----- end filter bar ----- #}

            {% if payroll_entries %}
                <p>Danh s√°ch <strong>{{ payroll_entries|length }}</strong> b·∫£ng l∆∞∆°ng ƒë√£ ƒë∆∞·ª£c t√≠nh cho k·ª≥ n√†y:</p>
                <ul class="list-group">
                {% for entry in payroll_entries %}
                    <li class="list-group-item">
                        <div class="row">
                            <div class="col-md-8">
                                <div><strong>Nh√¢n vi√™n:</strong> {{ entry.employee.full_name|default:entry.employee.employee_id }}</div>
                                <div><strong>Ng√†y c√¥ng:</strong> {{ entry.actual_worked_days }} / {{ entry.standard_worked_days }} ng√†y</div>
                                <div><strong>L∆∞∆°ng c∆° b·∫£n (Rate):</strong> {{ entry.basic_salary|floatformat:2 }} VND</div>
                                <div><strong>T·ªïng Ph·ª• c·∫•p:</strong> {{ entry.total_allowance|floatformat:2 }} VND</div>
                                <div><strong>T·ªïng Th∆∞·ªüng:</strong> {{ entry.total_reward|floatformat:2 }} VND</div>
                            </div>
                            <div class="col-md-4 text-right">
                                <div class="h6 text-danger">TH·ª∞C Lƒ®NH</div>
                                <div class="h4"><strong>{{ entry.received|floatformat:2 }} VND</strong></div>
                                <a href="{% url 'payroll_detail_view' entry.id %}" class="btn btn-sm btn-outline-info mt-2">Xem chi ti·∫øt</a>
                            </div>
                        </div>
                    </li>
                {% endfor %}
                </ul>
            {% else %}
                <p class="text-secondary">
                    {% if period %}
                        Ch∆∞a c√≥ b·∫£ng l∆∞∆°ng n√†o ƒë∆∞·ª£c t√≠nh cho k·ª≥ n√†y.
                    {% else %}
                        Vui l√≤ng ch·ªçn k·ª≥ l∆∞∆°ng v√† th·ª±c hi·ªán t√≠nh l∆∞∆°ng.
                    {% endif %}
                </p>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
